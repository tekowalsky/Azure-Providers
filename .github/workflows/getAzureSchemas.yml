name: Azure Schema List
on:
  workflow_dispatch:

jobs:
  Update:
    name: Update Azure Schema List
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ARM Schemas
        uses: actions/checkout@v2.4.0
        with:
          repository: Azure/azure-resource-manager-schemas
          path: ./azure-resource-manager-schemas
          fetch-depth: 0
          submodules: true
          
      - name: Copy ARM Schema Files
        run: |
          mkdir ./schemas
          mkdir ./schemas-preview
          mkdir ./common
          mkdir ./viewdefinition
          for dir in ./azure-resource-manager-schemas/schemas/20* ; do
            if [ "$dir" == "./azure-resource-manager-schemas/schemas/*preview" ]; then
              cd ./schemas-preview
              cp -ur $dir/*.json .
            else
              cd ./schemas
              cp -ur $dir/*.json .
            fi
            cd ..
          done
          ls -ltR ./azure-resource-manager-schemas/**/* > ./azure-resource-manager-schema.files.txt
          cd ./common
          cp -ur ../azure-resource-manager-schemas/schemas/common/* .
          cd ../viewdefinition
          cp -ur ../azure-resource-manager-schemas/schemas/viewdefinition/* .
        continue-on-error: true

      - name: Checkout My Repo
        uses: actions/checkout@v2.4.0
        with:
          repository: tekowalsky/Azure-Providers
          path: ./myrepo
          fetch-depth: 0
          submodules: true

      - name: Consolidate Latest ARM Schema Version Files
        run: |
          cd ./myrepo
          if [ -d ./azure ]; then
            echo "Found ./azure"
          else
            mkdir ./azure
          fi
          cd ./azure
          cp -f ../../azure-resource-manager-schema.files.txt .
          cp -ur ../../schemas .
          cp -ur ../../schemas-preview .
          cp -ur ../../common .
          cp -ur ../../viewdefinition .

      - name: Commit And Push ARM Schema Files
        run: |
          cd ./myrepo
          date > ./azure/updatedARMschema.txt
          git config user.name GetSchemas-Workflow
          git config user.email github-actions@github.com
          git add ./azure
          git commit -m "ARM Schema List updated by getAzureSchema workflow"
          git push
